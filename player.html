<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LibreTV 播放器</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="css/styles.css">
    <style>
        /* 优化后的CSS样式 */
        :root {
            --player-height: 60vh;
            --control-zindex: 1000;
            --transition-duration: 0.3s;
        }

        .player-container {
            width: 100%;
            max-width: 1200px;
            margin: 0 auto;
            position: relative;
        }

        #player {
            width: 100%;
            height: var(--player-height);
        }

        .loading-container {
            position: absolute;
            inset: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            background-color: rgba(0, 0, 0, 0.7);
            z-index: var(--control-zindex);
            flex-direction: column;
        }

        .loading-spinner {
            width: 50px;
            height: 50px;
            border: 4px solid rgba(255, 255, 255, 0.3);
            border-top-color: white;
            animation: spin 1s linear infinite;
            margin-bottom: 10px;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .error-container {
            /* 保持原有错误提示样式 */
        }

        .episode-active {
            background-color: #3b82f6 !important;
            border-color: #60a5fa !important;
        }

        .shortcut-hint {
            /* 优化动画效果 */
            transition: opacity var(--transition-duration) ease;
        }
    </style>
</head>
<body class="bg-[#0f1622] text-white">
    <!-- 保持原有DOM结构不变 -->
    <header class="bg-[#111] p-4 flex justify-between items-center border-b border-[#333]">
        <!-- 头部内容保持不变 -->
    </header>

    <main class="container mx-auto px-4 py-4">
        <div class="player-container">
            <div class="relative">
                <div id="player"></div>
                <!-- 加载和错误提示容器保持不变 -->
            </div>
            
            <!-- 集数导航和控件保持结构不变 -->
        </div>
    </main>

    <script src="https://cdn.jsdelivr.net/npm/hls.js@1.5.6/dist/hls.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/dplayer@1.26.0/dist/DPlayer.min.js"></script>
    <script src="js/config.js"></script>
    <script>
        // 使用模块模式封装代码
        (function() {
            'use strict';
            
            const app = {
                state: {
                    currentVideoTitle: '',
                    currentEpisodeIndex: 0,
                    currentEpisodes: [],
                    episodesReversed: false,
                    dp: null,
                    hls: null,
                    autoplay: true,
                    isSeeking: false,
                    videoEnded: false,
                    lastSaveTime: 0
                },

                init() {
                    this.parseURLParams();
                    this.setupUI();
                    this.initPlayer();
                    this.bindEvents();
                    this.restoreProgress();
                },

                parseURLParams() {
                    const params = new URLSearchParams(location.search);
                    this.state.currentVideoTitle = params.get('title') || '未知视频';
                    this.state.currentEpisodeIndex = Math.max(0, parseInt(params.get('index') || 0));
                    
                    try {
                        const episodes = params.get('episodes');
                        this.state.currentEpisodes = episodes ? JSON.parse(decodeURIComponent(episodes)) : [];
                    } catch(e) {
                        console.error('剧集解析失败:', e);
                        this.state.currentEpisodes = [];
                    }
                },

                setupUI() {
                    document.title = `${this.state.currentVideoTitle} - LibreTV`;
                    document.getElementById('videoTitle').textContent = this.state.currentVideoTitle;
                    this.updateEpisodeUI();
                    this.renderEpisodes();
                },

                initPlayer() {
                    const url = new URLSearchParams(location.search).get('url');
                    if (!url) return this.showError('无效的视频链接');

                    this.cleanupPlayer();
                    
                    this.state.dp = new DPlayer({
                        container: document.getElementById('player'),
                        video: {
                            url: url,
                            type: 'hls',
                            customType: {
                                hls: this.setupHLS.bind(this)
                            }
                        },
                        // 其他配置保持不变
                    });

                    this.bindPlayerEvents();
                },

                setupHLS(video) {
                    this.state.hls = new Hls({
                        // 优化HLS配置
                        maxBufferLength: 30,
                        maxMaxBufferLength: 60,
                        capLevelToPlayerSize: true
                    });

                    this.state.hls.loadSource(video.src);
                    this.state.hls.attachMedia(video);
                    this.setupHLSEvents();
                },

                bindPlayerEvents() {
                    const { dp } = this.state;
                    dp.on('loadedmetadata', this.onVideoReady.bind(this));
                    dp.on('error', this.onPlayerError.bind(this));
                    dp.on('ended', this.onVideoEnded.bind(this));
                    dp.video.addEventListener('timeupdate', this.onTimeUpdate.bind(this));
                },

                onVideoReady() {
                    this.hideLoading();
                    this.saveHistory();
                    this.setupProgressTracking();
                },

                onPlayerError() {
                    if (this.state.dp.video.readyState > 2) return;
                    this.showError('视频加载失败，请检查网络或源地址');
                },

                onVideoEnded() {
                    this.state.videoEnded = true;
                    if (this.state.autoplay) this.playNext();
                },

                onTimeUpdate() {
                    const now = Date.now();
                    if (now - this.state.lastSaveTime > 5000) {
                        this.saveProgress();
                        this.state.lastSaveTime = now;
                    }
                },

                // 其他方法保持类似结构，优化重复逻辑
                playEpisode(index) {
                    if (index < 0 || index >= this.state.currentEpisodes.length) return;
                    
                    this.saveProgress();
                    this.state.currentEpisodeIndex = index;
                    
                    const newURL = new URL(location.href);
                    newURL.searchParams.set('index', index);
                    newURL.searchParams.set('url', this.state.currentEpisodes[index]);
                    history.replaceState(null, '', newURL);

                    this.initPlayer();
                    this.updateEpisodeUI();
                },

                optimizeProgressBar() {
                    const bar = document.querySelector('.dplayer-bar-wrap');
                    if (!bar) return;

                    const handler = (e) => {
                        const rect = bar.getBoundingClientRect();
                        const percent = (e.clientX - rect.left) / rect.width;
                        const time = percent * this.state.dp.video.duration;
                        this.state.dp.seek(time);
                    };

                    bar.addEventListener('mousedown', handler);
                    bar.addEventListener('touchstart', e => handler(e.touches[0]));
                },

                cleanupPlayer() {
                    if (this.state.hls) {
                        this.state.hls.destroy();
                        this.state.hls = null;
                    }
                    if (this.state.dp) {
                        this.state.dp.destroy();
                        this.state.dp = null;
                    }
                },

                // 其他辅助方法...
            };

            // 初始化应用
            document.addEventListener('DOMContentLoaded', () => app.init());
        })();
    </script>
</body>
</html>
